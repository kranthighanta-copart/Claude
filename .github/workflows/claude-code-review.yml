name: Claude Code Review
on:
  workflow_call:
    inputs:
      pr-number:
        required: true
        type: number
        description: "Pull request number"
      head-sha:
        required: true
        type: string
        description: "Head commit SHA of the PR"
      base-branch:
        required: true
        type: string
        description: "Base branch of the PR (typically main or master)"
      repository:
        required: true
        type: string
        description: "Repository name in owner/repo format"
      trigger-phrase:
        required: false
        type: string
        default: '@milcheck'
        description: "Trigger phrase for comment-based reviews"
      max-files:
        required: false
        type: number
        default: 50
        description: "Maximum number of files to review"
      use-milchick-voice:
        required: false
        type: boolean
        default: false
        description: "If true, instructs the reviewer to use the voice of Seth Milchick from Severance."
    secrets:
      github-token:
        required: true
        description: "GitHub token with repo access"
      jira-token:
        required: true
        description: "Jira API token"
      claude-subscription-email:
        required: true
        description: "Claude subscription account email"
      claude-subscription-password:
        required: true
        description: "Claude subscription account password"

permissions:
  issues: write
  pull-requests: write
  contents: read

jobs:
  claude-review:
    name: Claude Code Review
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.repository }}
          ref: ${{ inputs.head-sha }}
          fetch-depth: 0
          token: ${{ secrets.github-token }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code
        shell: bash
        run: |
          npm install -g @anthropic-ai/claude-code@0.2.74
          echo "Claude Code installed successfully"

      - name: Authenticate with Claude Subscription
        id: claude-auth
        shell: bash
        env:
          CLAUDE_EMAIL: ${{ secrets.claude-subscription-email }}
          CLAUDE_PASSWORD: ${{ secrets.claude-subscription-password }}
        run: |
          # Authenticate with Claude using subscription credentials
          echo "Authenticating with Claude subscription account..."
          
          # Create a temporary script for Claude authentication
          cat > auth_claude.js << 'EOF'
          const https = require('https');
          const querystring = require('querystring');
          
          const email = process.env.CLAUDE_EMAIL;
          const password = process.env.CLAUDE_PASSWORD;
          
          if (!email || !password) {
            console.error('Missing email or password');
            process.exit(1);
          }
          
          // First, get the login page to extract any required tokens
          const getLoginPage = () => {
            return new Promise((resolve, reject) => {
              const options = {
                hostname: 'claude.ai',
                path: '/login',
                method: 'GET',
                headers: {
                  'User-Agent': 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36'
                }
              };
          
              const req = https.request(options, (res) => {
                let data = '';
                res.on('data', chunk => data += chunk);
                res.on('end', () => resolve({ data, headers: res.headers }));
              });
          
              req.on('error', reject);
              req.end();
            });
          };
          
          // Perform login
          const login = async () => {
            try {
              const loginPage = await getLoginPage();
          
              const postData = JSON.stringify({
                email_address: email,
                password: password
              });
          
              const options = {
                hostname: 'claude.ai',
                path: '/api/auth/human/login',
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Content-Length': Buffer.byteLength(postData),
                  'User-Agent': 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36',
                  'Accept': 'application/json',
                  'Origin': 'https://claude.ai',
                  'Referer': 'https://claude.ai/login'
                }
              };
          
              const req = https.request(options, (res) => {
                let data = '';
                res.on('data', chunk => data += chunk);
                res.on('end', () => {
                  try {
                    const response = JSON.parse(data);
          
                    // Extract session token from cookies or response
                    const cookies = res.headers['set-cookie'];
                    let sessionToken = null;
          
                    if (cookies) {
                      for (const cookie of cookies) {
                        const match = cookie.match(/sessionKey=([^;]+)/);
                        if (match) {
                          sessionToken = match[1];
                          break;
                        }
                      }
                    }
          
                    // Also check response body for token
                    if (!sessionToken && response.sessionKey) {
                      sessionToken = response.sessionKey;
                    }
          
                    if (sessionToken) {
                      console.log(`SESSION_TOKEN=${sessionToken}`);
                      process.exit(0);
                    } else {
                      console.error('No session token found in response');
                      console.error('Response:', data);
                      process.exit(1);
                    }
                  } catch (e) {
                    console.error('Failed to parse response:', e.message);
                    console.error('Raw response:', data);
                    process.exit(1);
                  }
                });
              });
          
              req.on('error', (error) => {
                console.error('Request error:', error.message);
                process.exit(1);
              });
          
              req.write(postData);
              req.end();
          
            } catch (error) {
              console.error('Login error:', error.message);
              process.exit(1);
            }
          };
          
          login();
          EOF
          
          # Run the authentication script
          AUTH_RESULT=$(node auth_claude.js)
          
          if [[ $AUTH_RESULT =~ SESSION_TOKEN=(.+) ]]; then
            SESSION_TOKEN="${BASH_REMATCH[1]}"
            echo "SESSION_TOKEN=${SESSION_TOKEN}" >> $GITHUB_ENV
            echo "Claude authentication successful"
            echo "auth_status=success" >> $GITHUB_OUTPUT
          else
            echo "Error: Failed to obtain Claude session token"
            echo "Auth result: $AUTH_RESULT"
          
            # Fallback: Try using Claude Code's built-in authentication
            echo "Attempting fallback authentication method..."
            if claude auth login --email="${CLAUDE_EMAIL}" --password="${CLAUDE_PASSWORD}" 2>/dev/null; then
              # Extract token from Claude Code config
              if [ -f ~/.config/claude-code/config.json ]; then
                SESSION_TOKEN=$(jq -r '.sessionToken // .sessionKey // .token' ~/.config/claude-code/config.json 2>/dev/null)
                if [[ -n "${SESSION_TOKEN}" && "${SESSION_TOKEN}" != "null" ]]; then
                  echo "SESSION_TOKEN=${SESSION_TOKEN}" >> $GITHUB_ENV
                  echo "Claude authentication successful via fallback"
                  echo "auth_status=success" >> $GITHUB_OUTPUT
                  exit 0
                fi
              fi
            fi
          
            echo "All authentication methods failed"
            exit 1
          fi
          
          # Cleanup
          rm -f auth_claude.js

      - name: Setup Claude Authentication
        shell: bash
        run: |
          # Create Claude config directory and set up authentication
          mkdir -p ~/.config/claude-code
          
          # Create config with session token obtained from subscription login
          cat > ~/.config/claude-code/config.json << EOF
          {
            "sessionToken": "${SESSION_TOKEN}"
          }
          EOF
          
          echo "Claude authentication configured with subscription-based session token"

      - name: Verify Claude Authentication
        if: steps.claude-auth.outputs.auth_status != 'success'
        run: |
          echo "Claude authentication failed"
          exit 1

      - name: Create review directories
        shell: bash
        run: |
          mkdir -p .claude-review/pr-info

      - name: Extract PR information
        shell: bash
        run: |
          # Fetch PR details
          PR_INFO=$(curl -s -H "Authorization: token ${{ secrets.github-token }}" \
            "https://api.github.com/repos/${{ inputs.repository }}/pulls/${{ inputs.pr-number }}")
          
          if [ -z "$PR_INFO" ]; then
            echo "Error: Failed to fetch PR information. Check the repository and PR number."
            exit 1
          fi

          PR_TITLE=$(echo "$PR_INFO" | jq -r .title)
          PR_AUTHOR=$(echo "$PR_INFO" | jq -r .user.login)
          TARGET_BRANCH="${{ inputs.base-branch }}"
          
          # Save PR info for Claude
          echo "$PR_INFO" > .claude-review/pr-info/pr-info.json
          
          # Set environment variables
          echo "PR_TITLE=$PR_TITLE" >> $GITHUB_ENV
          echo "PR_AUTHOR=$PR_AUTHOR" >> $GITHUB_ENV
          echo "TARGET_BRANCH=$TARGET_BRANCH" >> $GITHUB_ENV
          echo "JIRA_API_KEY=${{ secrets.jira-token }}" >> $GITHUB_ENV

      - name: Add Jira MCP integration
        shell: bash
        run: |
          cd .claude-review && claude mcp add jira -e JIRA_API_KEY=${{ secrets.jira-token }} -- npx -y @jira/mcp
          echo "Jira MCP integration added successfully"

      - name: Generate diff and prepare for review
        shell: bash
        run: |
          # Generate the diff between the PR and target branch
          git fetch origin ${{ inputs.base-branch }}:${{ inputs.base-branch }}
          COMMIT_BASE=$(git merge-base origin/${{ inputs.base-branch }} HEAD)
          git diff $COMMIT_BASE..HEAD > .claude-review/pr-changes.diff
          
          # List changed files
          git diff --name-only $COMMIT_BASE..HEAD > .claude-review/changed-files.txt
          
          # Get the total number of changed files
          TOTAL_FILES=$(wc -l < .claude-review/changed-files.txt | tr -d ' ')
          
          # Limit to max files if needed
          if [ "$TOTAL_FILES" -gt "${{ inputs.max-files }}" ]; then
            head -n ${{ inputs.max-files }} .claude-review/changed-files.txt > .claude-review/files-to-review.txt
            echo "Reviewing first ${{ inputs.max-files }} files out of $TOTAL_FILES changed files"
          else
            cp .claude-review/changed-files.txt .claude-review/files-to-review.txt
            echo "Reviewing all $TOTAL_FILES changed files"
          fi
          
          # For each file to review, get its content
          while IFS= read -r file; do
            if [ -f "$file" ]; then
              mkdir -p ".claude-review/$(dirname "$file")"
              cp "$file" ".claude-review/$file"
            fi
          done < .claude-review/files-to-review.txt

      - name: Run Claude Code Review
        shell: bash
        id: claude-review
        run: |
          # Create review prompt file
          cat > .claude-review/prompt.md << 'EOF'
          # Code Review Task

          You are an expert code reviewer examining a pull request. Please perform a thorough code review by:

          1. Understanding the PR context and intended changes from the PR title, description
          2. Looking for any Jira references in the PR description and commits (both ID formats like "YP-41221" and URLs like "https://jira.copart.com/browse/YP-41221")
          3. Use the Jira mcp__jira__read_ticket tool to fetch details about any referenced stories. If you are able to retrieve the story details, indicate what stories you analyzed in your review (also indicate if no stories were found, or if stories were found but unable to be fetched [include why]).
          4. Analyzing the code changes (diff) to identify:
             - Bugs, logic errors, or potential issues
             - Security vulnerabilities
             - Performance concerns
             - Adherence to best practices and coding standards
             - Completeness relative to the specifications
             - Test coverage and quality
          5. Providing constructive feedback with specific recommendations
          
          
          ## PR Information
          - Title: $PR_TITLE
          - Author: $PR_AUTHOR
          - Target Branch: $TARGET_BRANCH

          ## Accessing Jira Stories
          We use Jira as our ticketing system for assigning work.
          For any Jira stories you identify in the PR description or commit messages:
          1. Extract the Jira ID (numeric portion)
          2. Use the mcp__jira__read_ticket tool to get the details of the story
           (please indicate to the user if this process fails with specific details as to why) 
          3. Review the story requirements, description, and acceptance criteria

          ## Guidelines
          - Be thorough but concise
          - Highlight both issues and positive aspects
          - Prioritize feedback (critical issues first)
          - Provide specific examples and solutions when possible
          - Consider the context of the changes and their purpose
          - Focus on substance over style when possible

          ## Final Output Format
          Provide your review in markdown format with these sections:
          1. **Summary** - Overall assessment and key points. Indicate what Jira stories were used to analyze this, if any.
          2. **Recommendations** - Prioritized list of suggested changes
          3. **Detailed Review** - Organized by file/component with specific line references
          4. **Questions** - Any clarifications needed from the author

          Keep your review constructive and professional.
          EOF

          # Conditionally add Milchick voice instruction
          if [ "${{ inputs.use-milchick-voice }}" = "true" ]; then
            echo "" >> .claude-review/prompt.md # Add a newline for separation
            echo "Additionally, adopt the persona and voice of Seth Milchick from the TV show Severance for this review. Maintain his characteristic tone and mannerisms throughout your response." >> .claude-review/prompt.md
            echo "Milchick voice enabled."
          else
             echo "Standard professional voice enabled."
          fi

          # Replace environment variables in the prompt
          envsubst < .claude-review/prompt.md > .claude-review/prompt-filled.md
          
          # Run Claude Code in non-interactive mode
          echo "Starting Claude Code review process..."

          cd .claude-review && claude --allowedTools "mcp__jira__get-story" -p \
            "read prompt-filled.md, then analyze the PR info in pr-info/pr-info.json and the code changes in pr-changes.diff. \
            Examine each file listed in files-to-review.txt. \
            If you identify any Jira references in the PR description or commit messages, use the Jira API \
            to fetch the relevant story details for additional context. \
            Then provide a comprehensive code review as specified in the prompt." > review-output.md
          
          echo "Claude Code review completed"

      - name: Post review comment
        shell: bash
        run: |
          # Format review comment with prefix
          REVIEW_PREFIX="🔍 **Milcheck Code Review:**"
          REVIEW_CONTENT="$REVIEW_PREFIX

          $(cat .claude-review/review-output.md)
          
          <sub>This review was automatically generated by Claude Code using subscription authentication. If you have feedback on this review, please let the maintainers know.</sub>"
          
          # Post comment to PR
          RESPONSE=$(curl -s -X POST \
            -H "Authorization: token ${{ secrets.github-token }}" \
            -H "Accept: application/vnd.github.v3+json" \
            -w "%{http_code}" \
            "https://api.github.com/repos/${{ inputs.repository }}/issues/${{ inputs.pr-number }}/comments" \
            -d "{\"body\": $(echo "$REVIEW_CONTENT" | jq -s -R .)}")
          
          HTTP_CODE="$RESPONSE"

          if [ "$HTTP_CODE" -ge 400 ]; then
            echo "Error: Failed to post review comment. HTTP code: $HTTP_CODE"
            echo "Response: $RESPONSE"
            exit 1
          fi

          echo "Review comment posted to PR #${{ inputs.pr-number }}"